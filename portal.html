<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELEVATE | Ops Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Manrope', sans-serif; background-color: #F3F4F6; }
        .sidebar-item.active { background: #E85D3B; color: white; box-shadow: 0 10px 15px -3px rgba(232, 93, 59, 0.3); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        /* Urgency Indicators */
        .priority-3 { border-left: 6px solid #EF4444; } /* High */
        .priority-2 { border-left: 6px solid #F59E0B; } /* Medium */
        .priority-1 { border-left: 6px solid #10B981; } /* Low */
    </style>
</head>
<body class="antialiased">

    <div id="authOverlay" class="fixed inset-0 bg-[#0F1114] flex items-center justify-center z-[9999]">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-[#E85D3B]">ELEVATE<span>.</span></h1>
                <p class="text-gray-400 font-bold text-xs uppercase tracking-widest mt-2">Internal Management</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full p-4 bg-gray-50 border rounded-2xl outline-none focus:ring-2 focus:ring-[#E85D3B]" required>
                <input type="password" id="password" placeholder="Password" class="w-full p-4 bg-gray-50 border rounded-2xl outline-none focus:ring-2 focus:ring-[#E85D3B]" required>
                <button type="submit" class="w-full bg-[#E85D3B] text-white py-4 rounded-2xl font-black hover:scale-[1.02] transition-all">SIGN IN</button>
            </form>
        </div>
    </div>

    <div id="resetOverlay" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[10000] hidden">
        <div class="bg-white p-10 rounded-[2.5rem] max-w-sm w-full text-center">
            <div class="w-16 h-16 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="shield-alert" class="w-8 h-8"></i>
            </div>
            <h2 class="text-2xl font-black mb-2">Secure Your Account</h2>
            <p class="text-sm text-gray-500 mb-8">You are logged in with a temporary password. Create a permanent one to continue.</p>
            <form id="resetForm" class="space-y-4">
                <input type="password" id="newPass" placeholder="New Password" class="w-full p-4 border rounded-2xl" required minlength="8">
                <button type="submit" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black">UPDATE & ACCESS</button>
            </form>
        </div>
    </div>

    <div id="dashboard" class="flex min-h-screen hidden">
        <aside class="w-72 bg-white border-r flex flex-col p-6">
            <div class="text-2xl font-black text-[#E85D3B] mb-10 px-2">ELEVATE<span>.</span></div>
            <nav class="flex-1 space-y-2">
                <button onclick="switchTab('leads')" class="sidebar-item w-full flex items-center gap-3 p-4 rounded-2xl font-bold transition-all active">
                    <i data-lucide="layout-grid"></i> New Leads
                </button>
                <button onclick="switchTab('tasks')" class="sidebar-item w-full flex items-center gap-3 p-4 rounded-2xl font-bold transition-all">
                    <i data-lucide="list-todo"></i> My Journey Queue
                </button>
                <button id="adminTabBtn" onclick="switchTab('team')" class="sidebar-item w-full flex items-center gap-3 p-4 rounded-2xl font-bold transition-all hidden">
                    <i data-lucide="users"></i> Manage Team
                </button>
                <button onclick="switchTab('help')" class="sidebar-item w-full flex items-center gap-3 p-4 rounded-2xl font-bold transition-all">
                    <i data-lucide="help-circle"></i> Training Hub
                </button>
            </nav>
            <div class="mt-auto p-4 bg-gray-50 rounded-3xl">
                <div class="flex items-center gap-3 mb-4">
                    <div id="userAvatar" class="w-10 h-10 bg-[#E85D3B] text-white rounded-full flex items-center justify-center font-black">?</div>
                    <div>
                        <p id="uName" class="text-sm font-black">--</p>
                        <p id="uRole" class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">--</p>
                    </div>
                </div>
                <button id="logout" class="text-xs font-black text-red-500 uppercase flex items-center gap-2"><i data-lucide="log-out" class="w-3"></i> Log Out</button>
            </div>
        </aside>

        <main class="flex-1 p-10 overflow-y-auto">
            <div id="leadsTab" class="tab-panel active">
                <header class="mb-10 flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-black italic">Incoming Pipeline</h2>
                        <p class="text-gray-400 font-medium">New audit requests from the website.</p>
                    </div>
                </header>
                <div class="grid grid-cols-1 gap-4" id="leadsList">
                    </div>
            </div>

            <div id="tasksTab" class="tab-panel">
                <header class="mb-10">
                    <h2 class="text-3xl font-black italic">Active Marketing Journeys</h2>
                    <p class="text-gray-400 font-medium">Work assigned to you, sorted by urgency.</p>
                </header>
                <div id="taskGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="teamTab" class="tab-panel">
                <div class="max-w-xl bg-white p-10 rounded-[3rem] shadow-sm border">
                    <h2 class="text-2xl font-black mb-6">Onboard Staff</h2>
                    <form id="addStaffForm" class="space-y-4">
                        <input type="text" id="sName" placeholder="Full Name" class="w-full p-4 bg-gray-50 border rounded-2xl" required>
                        <input type="email" id="sEmail" placeholder="Email" class="w-full p-4 bg-gray-50 border rounded-2xl" required>
                        <button type="submit" class="w-full bg-black text-white py-4 rounded-2xl font-black">GENERATE STAFF PROFILE</button>
                    </form>
                    <div id="staffResult" class="mt-6 p-6 bg-orange-50 text-orange-800 rounded-3xl hidden">
                        <p class="text-xs font-black uppercase mb-2">Login Credentials Created:</p>
                        <div class="flex justify-between items-center font-mono font-bold">
                            <span id="tempPassDisplay"></span>
                            <button onclick="copyText('tempPassDisplay')" class="text-xs underline">COPY</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="helpTab" class="tab-panel">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-[#FFF0EC] p-10 rounded-[3rem] border border-[#F5DDD6]">
                        <h3 class="text-xl font-black text-[#B54629] mb-4">Operations Playbook</h3>
                        <a href="#" class="block p-4 bg-white rounded-2xl mb-3 font-bold flex justify-between">Caller Script (PDF) <i data-lucide="download"></i></a>
                        <a href="#" class="block p-4 bg-white rounded-2xl font-bold flex justify-between">Objection Handling <i data-lucide="play"></i></a>
                    </div>
                    <div class="bg-white p-10 rounded-[3rem] border">
                        <h3 class="text-xl font-black mb-4">Success Metrics</h3>
                        <ul class="space-y-4 text-sm font-medium text-gray-600">
                            <li class="flex gap-3"><i data-lucide="check-circle" class="text-green-500 w-5"></i> First contact must be made within 4 hours.</li>
                            <li class="flex gap-3"><i data-lucide="check-circle" class="text-green-500 w-5"></i> Every task must have a saved phone number.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="journeyModal" class="fixed inset-0 bg-black/60 z-[11000] hidden items-center justify-center p-6 backdrop-blur-md">
        <div class="bg-white w-full max-w-5xl rounded-[3.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-10 bg-[#0F1114] text-white flex justify-between items-center">
                <div>
                    <h2 id="mTitle" class="text-3xl font-black italic">--</h2>
                    <p id="mClient" class="text-gray-400 font-bold uppercase text-xs tracking-widest mt-1">--</p>
                </div>
                <button onclick="closeModal('journeyModal')" class="p-3 bg-white/10 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="p-10 overflow-y-auto flex-1 grid grid-cols-1 lg:grid-cols-3 gap-10">
                <div class="lg:col-span-2 space-y-8">
                    <section>
                        <h4 class="text-xs font-black uppercase text-gray-400 tracking-widest mb-6">Stage Checklist</h4>
                        <div id="mChecklist" class="space-y-3"></div>
                    </section>
                    <section class="p-8 bg-blue-50 rounded-[2.5rem] border border-blue-100">
                        <h4 class="font-bold text-blue-900 mb-2">Update Client Master File</h4>
                        <div class="flex gap-3">
                            <input type="text" id="mPhone" placeholder="Enter Client Phone Number" class="flex-1 p-4 rounded-2xl border-none ring-1 ring-blue-200 focus:ring-2 focus:ring-blue-600 outline-none">
                            <button onclick="savePhone()" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-black">SAVE</button>
                        </div>
                    </section>
                </div>
                <div class="space-y-6">
                    <div class="p-8 bg-[#FFF0EC] rounded-[2.5rem] border border-[#F5DDD6]">
                        <h4 class="font-black text-[#B54629] mb-4 flex items-center gap-2"><i data-lucide="message-square"></i> Strategy Script</h4>
                        <div id="mScript" class="text-sm text-[#B54629] leading-relaxed italic"></div>
                    </div>
                    <div class="p-8 bg-gray-50 rounded-[2.5rem]">
                        <h4 class="font-bold text-xs uppercase text-gray-400 mb-2">Time Tracking</h4>
                        <p id="mDue" class="text-lg font-black text-red-500 italic">--</p>
                    </div>
                </div>
            </div>
            <div class="p-10 border-t bg-gray-50 flex justify-end">
                <button onclick="finishStage()" class="bg-green-600 text-white px-12 py-5 rounded-2xl font-black shadow-xl shadow-green-200">MARK STAGE COMPLETE</button>
            </div>
        </div>
    </div>

    <div id="assignModal" class="fixed inset-0 bg-black/60 z-[11000] hidden items-center justify-center p-6">
        <div class="bg-white p-10 rounded-[3rem] w-full max-w-md">
            <h2 class="text-2xl font-black mb-2">Assign Account</h2>
            <p id="assignName" class="text-gray-400 font-bold text-sm mb-8 italic"></p>
            <div id="staffList" class="space-y-2"></div>
            <button onclick="closeModal('assignModal')" class="w-full mt-6 text-xs font-black text-gray-300 uppercase">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, setDoc, updateDoc, collection, onSnapshot, query, where, orderBy, serverTimestamp, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA_w1Idu6sj9-KTADvpAKWNWA9VK0y6xmA",
            authDomain: "elee-749cf.firebaseapp.com",
            projectId: "elee-749cf",
            storageBucket: "elee-749cf.firebasestorage.app",
            messagingSenderId: "517585589664",
            appId: "1:517585589664:web:b6a8d94772dfe80122c0c5",
            measurementId: "G-L4XGCPY6RM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        dayjs.extend(window.dayjs_plugin_relativeTime);

        let uProfile = null;
        let activeTask = null;
        let activeLeadId = null;

        // 1. AUTH & TEMP PASSWORD HANDLERS
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await signInWithEmailAndPassword(auth, email.value, password.value);
            } catch (err) { alert("Invalid Credentials"); }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                uProfile = snap.data();
                
                // FORCE RESET IF TEMP PASS
                if (uProfile?.isTemporary) {
                    document.getElementById('resetOverlay').classList.remove('hidden');
                } else {
                    initPortal();
                }
            } else {
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('authOverlay').classList.remove('hidden');
            }
        });

        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await updatePassword(auth.currentUser, newPass.value);
            await updateDoc(doc(db, "users", auth.currentUser.uid), { isTemporary: false });
            location.reload();
        });

        // 2. DASHBOARD INITIALIZATION
        function initPortal() {
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('resetOverlay').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            uName.innerText = uProfile.name;
            uRole.innerText = uProfile.role;
            userAvatar.innerText = uProfile.name.charAt(0);
            
            if(uProfile.role === 'admin') {
                document.getElementById('adminTabBtn').classList.remove('hidden');
                syncLeads();
            }
            syncTasks();
            lucide.createIcons();
        }

        // 3. ADMIN: LEAD SYNC (AUTO-CREATION OF DATA VIEW)
        function syncLeads() {
            onSnapshot(collection(db, "audit_requests"), (snap) => {
                const list = document.getElementById('leadsList');
                list.innerHTML = '';
                snap.forEach(d => {
                    const lead = d.data();
                    list.innerHTML += `
                        <div class="bg-white p-6 rounded-[2rem] shadow-sm border flex items-center justify-between">
                            <div>
                                <h4 class="font-black text-lg">${lead.name}</h4>
                                <p class="text-xs font-bold text-gray-400 uppercase">${lead.revenue} Rev â€¢ ${lead.status || 'UNASSIGNED'}</p>
                            </div>
                            <button onclick="showAssign('${d.id}', '${lead.name}')" class="bg-black text-white px-6 py-3 rounded-2xl font-black text-xs">ASSIGN TO STAFF</button>
                        </div>
                    `;
                });
            });
        }

        window.showAssign = async (id, name) => {
            activeLeadId = id;
            assignName.innerText = name;
            const staff = await getDocs(query(collection(db, "users"), where("role", "==", "employee")));
            staffList.innerHTML = '';
            staff.forEach(s => {
                staffList.innerHTML += `
                    <button onclick="assignLead('${s.id}', '${s.data().name}')" class="w-full text-left p-4 bg-gray-50 rounded-2xl font-bold hover:bg-[#FFF0EC] transition-all flex justify-between">
                        ${s.data().name} <i data-lucide="chevron-right"></i>
                    </button>
                `;
            });
            document.getElementById('assignModal').classList.remove('hidden');
            lucide.createIcons();
        };

        window.assignLead = async (uid, empName) => {
            const leadSnap = await getDoc(doc(db, "audit_requests", activeLeadId));
            const lead = leadSnap.data();

            // Auto-create Journey Task
            await addDoc(collection(db, "tasks"), {
                assignedTo: uid,
                clientId: activeLeadId,
                clientName: lead.name,
                title: "Setup Outreach Call",
                status: "active",
                urgency_score: 3,
                phase: "Initial Contact",
                checklist: [
                    { text: "Draft audit summary email", done: false },
                    { text: "Find Instagram profile", done: false },
                    { text: "Send DM via Reddit/IG", done: false },
                    { text: "Request phone for WhatsApp", done: false }
                ],
                dueAt: Timestamp.fromDate(new Date(Date.now() + 6 * 3600000)), // 6 hour deadline
                updatedAt: serverTimestamp()
            });

            await updateDoc(doc(db, "audit_requests", activeLeadId), { status: 'assigned', assignedTo: uid });
            closeModal('assignModal');
        };

        // 4. EMPLOYEE: TASK SYNC & JOURNEY
        function syncTasks() {
            const q = query(
                collection(db, "tasks"), 
                where("assignedTo", "==", auth.currentUser.uid), 
                where("status", "==", "active"),
                orderBy("urgency_score", "desc")
            );

            onSnapshot(q, (snap) => {
                const grid = document.getElementById('taskGrid');
                grid.innerHTML = '';
                snap.forEach(d => {
                    const t = d.data();
                    const urgency = `priority-${t.urgency_score}`;
                    grid.innerHTML += `
                        <div onclick="openJourney('${d.id}')" class="bg-white p-8 rounded-[3rem] shadow-sm border ${urgency} cursor-pointer hover:shadow-xl transition-all">
                            <div class="flex justify-between items-start mb-6">
                                <span class="text-[10px] font-black uppercase text-gray-400 tracking-widest">${t.phase}</span>
                                <i data-lucide="clock" class="w-4 text-gray-300"></i>
                            </div>
                            <h3 class="text-xl font-black mb-1">${t.title}</h3>
                            <p class="text-sm text-gray-500 font-bold italic mb-6">${t.clientName}</p>
                            <div class="text-[10px] font-black uppercase text-red-500 bg-red-50 px-3 py-1 rounded-full w-fit">
                                Due ${dayjs(t.dueAt.toDate()).fromNow()}
                            </div>
                        </div>
                    `;
                });
                lucide.createIcons();
            });
        }

        window.openJourney = async (id) => {
            const snap = await getDoc(doc(db, "tasks", id));
            activeTask = { id, ...snap.data() };
            
            mTitle.innerText = activeTask.title;
            mClient.innerText = `Client Journey: ${activeTask.clientName}`;
            mPhone.value = activeTask.phone || '';
            mDue.innerText = `Deadline: ${dayjs(activeTask.dueAt.toDate()).fromNow()}`;
            
            // Logic-based scripts
            mScript.innerText = activeTask.phase === "Initial Contact" 
                ? "Send this: 'Hey [Name], I have your audit finished and the numbers look incredible. When can you hop on a 15-min call to go over the strategy?'"
                : "Standard follow up: 'Checking in to see if you saw the message I sent yesterday...'";

            mChecklist.innerHTML = activeTask.checklist.map((c, i) => `
                <label class="flex items-center gap-4 p-5 bg-gray-50 rounded-3xl border-2 border-transparent hover:border-orange-200 cursor-pointer transition-all">
                    <input type="checkbox" onchange="toggleStep(${i})" ${c.done ? 'checked' : ''} class="w-6 h-6 accent-[#E85D3B]">
                    <span class="font-bold text-gray-700 ${c.done ? 'line-through opacity-40' : ''}">${c.text}</span>
                </label>
            `).join('');

            document.getElementById('journeyModal').classList.remove('hidden');
        };

        window.toggleStep = async (idx) => {
            activeTask.checklist[idx].done = !activeTask.checklist[idx].done;
            await updateDoc(doc(db, "tasks", activeTask.id), { checklist: activeTask.checklist });
        };

        window.savePhone = async () => {
            const num = mPhone.value;
            await updateDoc(doc(db, "tasks", activeTask.id), { phone: num });
            // Update master client file
            await updateDoc(doc(db, "audit_requests", activeTask.clientId), { phone: num });
            alert("File Updated.");
        };

        window.finishStage = async () => {
            if(!confirm("Ready to finish this marketing stage?")) return;
            await updateDoc(doc(db, "tasks", activeTask.id), { status: 'completed' });
            closeModal('journeyModal');
        };

        // 5. STAFF CREATION
        document.getElementById('addStaffForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const temp = "Elevate@" + Math.floor(1000 + Math.random() * 9000);
            document.getElementById('staffResult').classList.remove('hidden');
            tempPassDisplay.innerText = temp;
            
            // NOTE: Manually create the user in the Auth tab, then this creates the Profile.
            const fakeId = "USER_" + Math.random().toString(36).substr(2, 9);
            await setDoc(doc(db, "users", fakeId), {
                name: sName.value,
                email: sEmail.value,
                role: 'employee',
                isTemporary: true
            });
        });

        // UI HELPERS
        window.switchTab = (id) => {
            document.querySelectorAll('.tab-panel').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(s => s.sidebar-item.classList.remove('active'));
            document.getElementById(id + 'Tab').classList.add('active');
            event.currentTarget.classList.add('active');
        };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        document.getElementById('logout').addEventListener('click', () => signOut(auth));
        window.copyText = (id) => { navigator.clipboard.writeText(document.getElementById(id).innerText); alert("Copied!"); };

    </script>
</body>
</html>